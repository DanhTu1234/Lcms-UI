<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Review Kết Quả Quiz</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .quiz-container { flex: 1; margin: 30px auto; max-width: 1100px; background: white; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); padding: 20px; }
    .question-image { width: 100%; max-height: 250px; object-fit: cover; border-radius: 8px; }
    .circle-btn { width: 40px; height: 40px; margin: 5px; border-radius: 50%; border: none; color: white; font-weight: bold; }
    .circle-btn.default { background: #6c757d; }
    .circle-btn.answered { background: #0d6efd; }
    .circle-btn.correct { background: #198754; }
    .circle-btn.wrong { background: #dc3545; }
    .circle-btn.active { border: 2px solid #000; }
    .form-check-label.correct { color: #198754; font-weight: 600; }
    .form-check-label.wrong { color: #dc3545; font-weight: 600; }
    .sidebar { border-left: 1px solid #ddd; padding-left: 20px; }
  </style>
</head>
<body>
    <div id="header"></div>

    <div class="quiz-container row">
        <!-- LEFT CONTENT -->
        <div class="col-md-8 content" id="question-area">
        <h4 class="mb-3">Đang tải dữ liệu...</h4>
        </div>

        <!-- RIGHT SIDEBAR -->
        <div class="col-md-4 sidebar text-center">
        <div id="timer" class="timer mb-3 fw-bold text-danger fs-4"></div>
        <div class="d-flex flex-wrap justify-content-center" id="sidebar-buttons"></div>
        <div class="mt-4">
            <small class="text-muted">Số câu đúng: <span id="correctCount" class="text-success fw-bold">0</span></small><br>
            <small class="text-muted">Tổng câu: <span id="totalCount">0</span></small><br>
            <!-- <small class="text-muted">Thời gian làm bài: <span id="duration"></span></small> -->
        </div>
        </div>
    </div>

    <div id="footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../assets/js-user/alert.js"></script>
    <script src="../assets/js-user/include.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/keycloak-js@25.0.6/dist/keycloak.min.js"></script>
    <script src="../assets/js-user/keycloak.js"></script>
    <script>
        const questionArea = document.getElementById("question-area");
        const sidebarButtons = document.getElementById("sidebar-buttons");
        const correctCountEl = document.getElementById("correctCount");
        const totalCountEl = document.getElementById("totalCount");
        const durationEl = document.getElementById("duration");

        const attemptId = new URLSearchParams(window.location.search).get("attemptId");
        let quizData = null;
        let currentIndex = 0;

        async function loadReview() {
            try {
                const res = await axios.get(`http://localhost:8444/api/quizz/review/${attemptId}`);
                quizData = res.data;

                totalCountEl.textContent = quizData.questions.length;
                renderSidebar();
                renderQuestion();
                calcSummary();
            } catch (err) {
                console.error(err);
                questionArea.innerHTML = `<div class="alert alert-danger">Không thể tải dữ liệu bài làm!</div>`;
            }
        }

        function renderSidebar() {
            sidebarButtons.innerHTML = quizData.questions.map((q, i) => {
                let cls = "circle-btn default";
                const correctAnswers = q.answers.filter(a => a.is_correct).map(a => a.id);
                const chosenAnswers = q.answers.filter(a => a.is_chosen).map(a => a.id);

                //Đúng khi và chỉ khi chọn chính xác toàn bộ đáp án đúng
                const isCorrect =
                    correctAnswers.length === chosenAnswers.length &&
                    correctAnswers.every(id => chosenAnswers.includes(id));

                const hasChosen = chosenAnswers.length > 0;

                if (isCorrect) cls = "circle-btn correct";
                else if (hasChosen) cls = "circle-btn wrong";

                return `<button class="${cls}" onclick="jumpTo(${i})">${i + 1}</button>`;
            }).join("");
        }


        function renderQuestion() {
            const q = quizData.questions[currentIndex];
            let answersHTML = q.answers.map(a => {
                let labelClass = "";
                let icon = "";
                if (a.is_correct) {
                    labelClass = "correct";
                    icon = "✔";
                } else if (a.is_chosen && !a.is_correct) {
                    labelClass = "wrong";
                    icon = "✘";
                }

                return `
                <div class="form-check">
                    <input class="form-check-input" type="radio" disabled ${a.is_chosen ? "checked" : ""}>
                    <label class="form-check-label ${labelClass}">
                    ${a.answer_text} ${icon ? `<span class="fw-bold">${icon}</span>` : ""}
                    </label>
                </div>
                `;
            }).join("");

            questionArea.innerHTML = `
                <h4 class="mb-3">${quizData.title}</h4>
                ${q.media_url ? `<img src="${q.media_url}" class="question-image" alt="Question image">` : ""}
                <h5 class="mt-3">Câu hỏi ${currentIndex + 1}: ${q.content}</h5>
                ${answersHTML}
                <div class="d-flex justify-content-between mt-4">
                <button class="btn btn-secondary" onclick="prevQuestion()">Prev</button>
                <button class="btn btn-primary" onclick="nextQuestion()">Next</button>
                </div>
            `;
            updateSidebarHighlight();
        }

        function updateSidebarHighlight() {
            const buttons = sidebarButtons.querySelectorAll(".circle-btn");
            buttons.forEach((btn, i) => {
                btn.classList.toggle("active", i === currentIndex);
            });
        }

        function nextQuestion() {
            if (currentIndex < quizData.questions.length - 1) {
                currentIndex++;
                renderQuestion();
            }
        }

        function prevQuestion() {
            if (currentIndex > 0) {
                currentIndex--;
                renderQuestion();
            }
        }

        function jumpTo(i) {
            currentIndex = i;
            renderQuestion();
        }

        function calcSummary() {
            let correct = 0;
            quizData.questions.forEach(q => {
                const correctAnswers = q.answers.filter(a => a.is_correct).map(a => a.id);
                const chosenAnswers = q.answers.filter(a => a.is_chosen).map(a => a.id);
                const isCorrect =
                    correctAnswers.length === chosenAnswers.length &&
                    correctAnswers.every(id => chosenAnswers.includes(id));
                if (isCorrect) correct++;
            });
            correctCountEl.textContent = correct;
        }
        document.addEventListener("kc-ready", loadReview);
    </script>

</body>
</html>  